---
title: первый
---
# Билет
HTTP-протокол (методы запросов, тело запроса, тело ответа, параметры запроса, заголовки, статусные коды ответа, общая логика протокола), cookie, основные заголовки. Защита от повторной отправки форм
# HTTP-протокол
## Определение
Для взаимодействия приложений нужен некий стандарт, набор правил взаимодействий. Сетевой протокол - набор правил, действий, форматов, регламентирующий обмен данными между узлами сети

**Протоколы передачи данных**
- Симплексный режим: односторонняя связь
- Полудуплексный режим: в определенный момент времени передача данных только в одну сторону (HTTP)
- Полнодуплексный режим: в определенный момент времени передача данных в обе стороны (WebSocket)

**HTTP** - полудуплексный протокол обмена данными при клиент-серверном взаимодействии
- Протокол прикладного уровня (HTTP 1.1 - актуальная версия)
- Благодаря HTTP обеспечивается работа Всемирной паутины

**Схема работы HTTP**
- Клиентское приложение формирует запрос и отправляет его на сервер
- После чего серверное ПО обрабатывает полученный запрос
- Формирует ответ на него его и отправляет обратно клиенту

## Методы запросов
Метод HTTP запроса указывает серверу, как нужно обращаться к запрашиваемому ресурсу, который указан в URI
- **GET** - запрашивает ответ у сервера по заданному URI
- **POST** - публикует информацию на сервере
- **PUT** - для загрузки содержимого запроса на указанный в этом же запросе URI
- **PATCH** - используется для частичного изменения ресурса
- **DELETE** - удаляет указанный в URI ресурс
- **CONNECT** - преобразует текущее соединение в тоннель
- **HEAD** - работает как GET, но в ответ сервер посылает только заголовки и статусную строку без тела HTTP сообщения
- **OPTIONS** - для получения параметров текущего HTTP соединения
- **TRACE** - создает петлю, благодаря которой клиент может увидеть, что происходит с сообщением на всех узлах передачи

## Запрос
**Схема запроса**: *METHOD path Protocol*

**Пример запроса**: *POST /forum/topic.php?id=42 HTTP/1.1*

**Структура запроса**:
1. Стартовая строка в виде METHOD path Protocol
2. Различные другие заголовки запроса, такие как User-Agent, Host, Accept, Content-Length, Authorization, Accept-Encoding и т.д. Название заголовка отделяется от его значения двоеточием и пробелом.
3. Иногда еще передается тело запроса (например, это нужно для POST-запросов). Тело запроса отделяется от заголовков одной пустой строкой.

**Query string**: дополнительная информация (пары ключ-значение), передаваемая вместе с запросом. Видна в адресной строке. Они являются средством по умолчанию для передачи информации от клиента к серверу для GET запросов. Query string отделяются от основной части URL вопросительным знаком и друг от друга символом &

**Пример query string**: *peers=22929017&sel=136196802*

## Ответ
**Схема ответа**: *Protocol CODE STATUS*

**Пример ответа**: *HTTP/1.1 200 OK*

**Структура ответа**:
1. Protocol CODE STATUS
2. Заголовки ответа, такие как Content-Type, Content-Length, Content-Encoding, Location и т.д
3. Непосредственное содержимое (тело) ответа (html, json или др.). Отделяется от заголовков одной пустой строкой.

## Статусные коды ответа
Код состояния - три цифры (первая указывает на класс состояния), которые определяют результат совершения запроса. Набор кодов состояния является стандартом.
- 1xx: Informational
  - 100 - Continue.
  - 101 - Switching Protocols. Указывает протокол, на который переключается сервер.
- 2xx: Success
  - 200 - OK. Тут понятно, говорит о том, что запрос прошёл успешно.
  - 201 - Created. Обычно используется при POST/PUT запросах, чтобы сказать, что ресурс был создан успешно.
  - 202 - Accepted
- 3xx: Redirection
  - 301 - Moved Permanently. Браузер запоминает эти движения и может начать редиректить, когда это не нужно, так что аккуратнее
  - 302 - Found / Moved Temporarily. Браузер не запоминает эти движения, используется чаще всего
- 4xx: Client Error
  - 401 - Unauthorized. Говорит о том, что пользователь не авторизован.
  - 402 - Payment Required. Говорит о том, что нужна оплата (возможно, какой-то платный ресурс)
  - 403 - Forbidden. Обычно приходит, когда к какому-то ресурсу нет доступа.
  - 404 - Not Found. Говорит о том, что ресурс не найден.
  - 429 - Too Many Requests. Защита от частых запросов - своеобразная защита от DDoS-атак
  - 451 - Unavailable For Legal Reasons. Говорит о том, что ресурс запрещён для просмотра в Вашей стране. Какие-то ресурсы могут быть запрещены в определённых странах из-за их законодательства. 
- 5xx: Server Error
  - 500 - Internal Server Error
  - 502 - Bad Gateway
# cookie
## Определение
**Cookie** — небольшой фрагмент данных, отправленный веб-сервером и хранимый на компьютере пользователя. Веб-клиент (обычно веб-браузер) всякий раз при попытке открыть страницу соответствующего сайта пересылает этот фрагмент данных веб-серверу в составе HTTP-запроса

## Атрибуты
- key устанавливает имя cookie-файла.
- value сохраняет значение cookie, которое будет идентифицировать пользователя или содержать служебную информацию.
- expires и max-age определяют срок жизни cookie, по истечению которого она будет автоматически удалена. Если не указать этот параметр, или установить его значение в ноль, то cookie будут автоматически удалены при закрытии браузера. Для параметра expires указывается конечная дата в формате Tue, 01-Sep-2020 10:50:22 GMT, тогда как для max-age устанавливается количество секунд жизни cookie с момента установки её в браузер.
- path указывает путь к директории на сервере, для которой будут доступны cookie. Если указать корневой каталог /, то cookie будут доступны всему домену. По умолчанию значением является текущая директория, из которой cookie устанавливаются в браузер.
- domain отмечает, какой домен или поддомен имеет доступ к этой cookie. Для того, чтобы сделать cookie доступными для всего домена (включая поддомены), нужно просто указать имя домена (например example.com).

## Принцип работы
Как и любой другой HTTP-заголовок, cookie должны передаваться в браузер до того, как будут переданы какие-либо другие данные, включая пустые строки и пробельные символы (это ограничение HTTP-протокола).

Запрашивая страницу, браузер отправляет веб-серверу HTTP-запрос. 

Сервер отвечает, отправляя запрашиваемую страницу вместе с текстом, содержащим HTTP-ответ. Там может содержаться указание браузеру сохранить cookie:

Set-Cookie: key=value

Строка Set-cookie отправляется лишь тогда, когда сервер желает, чтобы браузер сохранил cookie. В этом случае, если cookie поддерживаются браузером и их приём включен, браузер запоминает строку key=value (ключ = значение) и отправляет её обратно серверу с каждым последующим запросом. 

Таким образом, сервер узнает, что этот запрос связан с предыдущим. Сервер отвечает, отправляя запрашиваемую страницу и, возможно, добавив новые cookie.

## Cookie in Java
Метод `void addCookie(Cookie cookie)` у HttpServletResponse добавляет к ответу указанный cookie.

Чтобы удалить куки - нужно наоборот установить куки с нужным именем, но с прошедшим Expires или нулевым MaxAge

Чтобы получить куки - используем `Cookie[] getCookies()` у HttpServletRequest

# Основные заголовки
- `User-Agent` - Название браузера, его движка, OC (Mozilla/5.0)
- `Accept-Language` - Какие языки ожидаются браузером (ru-RU)
- `Referer` - Кто побудил браузер выполнить запрос (https://google.com)
- `Date` - Время генерации ответа веб-сервера (Wed, 27, 1970)
- `Content-type`, `Content-Length` - Тип в формате MiMe ([[Одиннадцатый|смотреть здесь]]) и размер в байтах
- `Last-Modified` - Время последнего изменения, кэширования (Mar, 16, 2004)

# Защита от повторной отправки форм
Для защиты от повторной отправки формы в Java можно использовать токен CSRF (Cross-Site Request Forgery). 
1. Сгенерируйте токен CSRF при каждой загрузке страницы, добавив его в скрытое поле формы
2. При отправке формы проверьте, что значение токена CSRF совпадает с сохраненным значением на сервере
3. Если значения не совпадают, то запрос должен быть отклонен